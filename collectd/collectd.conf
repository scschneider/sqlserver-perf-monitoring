#
# Config file for collectd(1).
# Please read collectd.conf(5) for a list of options.
# http://collectd.org/
#

##############################################################################
# Global                                                                     #
#----------------------------------------------------------------------------#
# Global settings for the daemon.                                            #
##############################################################################

Hostname    "##SQL_HOSTNAME##"
FQDNLookup   false

#BaseDir     "/var/lib/collectd"
#PIDFile     "/var/run/collectd.pid"
#PluginDir   "/usr/lib64/collectd"
#TypesDB     "/usr/share/collectd/types.db"

#----------------------------------------------------------------------------#
# When enabled, plugins are loaded automatically with the default options    #
# when an appropriate <Plugin ...> block is encountered.                     #
# Disabled by default.                                                       #
#----------------------------------------------------------------------------#
#AutoLoadPlugin false

#----------------------------------------------------------------------------#
# When enabled, internal statistics are collected, using "collectd" as the   #
# plugin name.                                                               #
# Disabled by default.                                                       #
#----------------------------------------------------------------------------#
#CollectInternalStats false

#----------------------------------------------------------------------------#
# Interval at which to query values. This may be overwritten on a per-plugin #
# base by using the 'Interval' option of the LoadPlugin block:               #
#   <LoadPlugin foo>                                                         #
#       Interval 60                                                          #
#   </LoadPlugin>                                                            #
#----------------------------------------------------------------------------#
Interval     5

#MaxReadInterval 86400
Timeout         2
#ReadThreads     5
WriteThreads    5

# Limit the size of the write queue. Default is no limit. Setting up a limit is
# recommended for servers handling a high volume of traffic.
#WriteQueueLimitHigh 1000000
#WriteQueueLimitLow   800000

##############################################################################
# Logging                                                                    #
#----------------------------------------------------------------------------#
# Plugins which provide logging functions should be loaded first, so log     #
# messages generated when loading or configuring other plugins can be        #
# accessed.                                                                  #
##############################################################################


#LoadPlugin logfile
#LoadPlugin log_logstash

#<Plugin logfile>
#	LogLevel info
#	File STDOUT
#	Timestamp true
#	PrintSeverity false
#</Plugin>

#<Plugin log_logstash>
#	LogLevel info
#	File "/var/log/collectd.json.log"
#</Plugin>

#<Plugin syslog>
#	LogLevel info
#</Plugin>

##############################################################################
# LoadPlugin section                                                         #
#----------------------------------------------------------------------------#
# Lines beginning with a single `#' belong to plugins which have been built  #
# but are disabled by default.                                               #
#                                                                            #
# Lines begnning with `##' belong to plugins which have not been built due   #
# to missing dependencies or because they have been deactivated explicitly.  #
##############################################################################

LoadPlugin network
LoadPlugin cpu
LoadPlugin df
LoadPlugin load
LoadPlugin memory
LoadPlugin disk
LoadPlugin interface
LoadPlugin uptime
LoadPlugin swap
LoadPlugin processes

##############################################################################
# Plugin configuration                                                       #
#----------------------------------------------------------------------------#
# In this section configuration stubs for each plugin are provided. A desc-  #
# ription of those options is available in the collectd.conf(5) manual page. #
##############################################################################

<Plugin "network">
    Server "##INFLUX_DB_SERVER##" "##INFLUX_DB_PORT##"
</Plugin>

<LoadPlugin dbi>
    Interval ##SQL_POLL_INTERVAL##
</LoadPlugin>

<Plugin dbi>
    <Query "metrics">
        Statement "select replace(replace(replace(replace(replace(rtrim(object_name) + '.' + rtrim(counter_name) + case when len(rtrim(instance_name)) = 0 then '' else '.' end + rtrim(instance_name), ' ', ''), ':','.'),'(',''),')',''),'/','_') as instance, cntr_value as value from Sys.dm_os_performance_counters with (nolock) where object_name in ('SQLServer:Buffer Manager', 'SQLServer:Databases ', 'SQLServer:Latches', 'SQLServer:Locks', 'SQLServer:Memory Manager', 'SQLServer:SQL Statistics', 'SQLServer:Wait Statistics', 'SQLServer:Memory Broker Clerks') or object_name = 'SQLServer:Workload Group Stats' and counter_name = 'CPU usage %' order by instance_name asc"
            <Result>
                Type "gauge"
                InstancesFrom "instance"
                ValuesFrom "value"
            </Result>
    </Query>

    <Database "master">
        Host "##SQL_HOSTNAME##"
        Driver "freetds"
        DriverOption "host" "127.0.0.1"
        DriverOption "username" "##SQL_USERNAME##"
        DriverOption "password" "##SQL_PASSWORD##"
        Query "metrics"
    </Database>
</Plugin>

<Plugin df>
    # expose host's mounts into container using -v /:/host:ro  (location inside container does not matter much)
    # ignore rootfs; else, the root file-system would appear twice, causing
    # one of the updates to fail and spam the log
    FSType rootfs
    # ignore the usual virtual / temporary file-systems
    FSType sysfs
    FSType proc
    FSType devtmpfs
    FSType devpts
    FSType tmpfs
    FSType fusectl
    FSType cgroup
    FSType overlay
    FSType debugfs
    FSType pstore
    FSType securityfs
    FSType hugetlbfs
    FSType squashfs
    FSType mqueue
    MountPoint "/etc/resolv.conf"
    MountPoint "/etc/hostname"
    MountPoint "/etc/hosts"
    IgnoreSelected true
    ReportByDevice false
    ReportReserved true
    ReportInodes true
    ValuesAbsolute true
    ValuesPercentage true
    ReportInodes true
</Plugin>

<Plugin "disk">
    Disk "/^[s]d[a-z]?$/"
    Disk "/^dm-[0-9]?$/"
    IgnoreSelected false
</Plugin>

<Plugin cpu>
    ReportByState true
    ReportByCpu true
    ValuesPercentage true
</Plugin>

<Plugin interface>
    Interface "lo"
    Interface "/^veth.*/"
    Interface "/^docker.*/"
    IgnoreSelected true
</Plugin>

<Plugin "processes">
    ProcessMatch "sqlservr" "sqlservr"
    ProcessMatch "sqlcmd" "sqlcmd"
</Plugin>

<Include "/etc/collectd/collectd.conf.d">
    Filter "*.conf"
</Include>
